# Architecture Documentation

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         User Traffic                            │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   Route 53    │  ◄── DNS-based Failover
                    │ (Failover DNS)│
                    └───────┬───────┘
                            │
              ┌─────────────┴──────────────┐
              │                            │
    ┌─────────▼──────────┐     ┌──────────▼──────────┐
    │   PRIMARY (AWS)    │     │  FALLBACK (GCP)     │
    │                    │     │                     │
    │  ┌──────────────┐  │     │  ┌──────────────┐  │
    │  │     ALB      │  │     │  │  Global LB   │  │
    │  └──────┬───────┘  │     │  └──────┬───────┘  │
    │         │          │     │         │          │
    │  ┌──────▼───────┐  │     │  ┌──────▼───────┐  │
    │  │ ECS Fargate  │  │     │  │  Cloud Run   │  │
    │  │  (2-10 tasks)│  │     │  │ (1-10 inst.) │  │
    │  └──────────────┘  │     │  └──────────────┘  │
    │                    │     │                     │
    │  Auto-Scaling:     │     │  Auto-Scaling:     │
    │  - CPU: 70%        │     │  - Automatic       │
    │  - Memory: 80%     │     │  - Request-based   │
    └────────────────────┘     └─────────────────────┘
```

## AWS Fargate Architecture (Primary)

```
┌──────────────────────────────────────────────────────────────┐
│                         VPC (10.0.0.0/16)                    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │         Availability Zone 1     │  Availability Zone 2    │
│  │                                │                     │    │
│  │  ┌──────────────┐  ┌──────────────┐               │    │
│  │  │ Public Subnet│  │ Public Subnet│               │    │
│  │  │  10.0.0.0/24 │  │  10.0.1.0/24 │               │    │
│  │  │              │  │              │               │    │
│  │  │ ┌──────────┐ │  │ ┌──────────┐ │  ┌─────────┐ │    │
│  │  │ │   ALB    │ │  │ │   ALB    │ │  │Internet │ │    │
│  │  │ └────┬─────┘ │  │ └────┬─────┘ │  │ Gateway │ │    │
│  │  │      │       │  │      │       │  └─────────┘ │    │
│  │  └──────┼───────┘  └──────┼───────┘               │    │
│  │         │                 │                        │    │
│  │  ┌──────▼───────┐  ┌──────▼───────┐               │    │
│  │  │Private Subnet│  │Private Subnet│               │    │
│  │  │ 10.0.10.0/24 │  │ 10.0.11.0/24 │               │    │
│  │  │              │  │              │               │    │
│  │  │ ┌──────────┐ │  │ ┌──────────┐ │               │    │
│  │  │ │  Fargate │ │  │ │  Fargate │ │               │    │
│  │  │ │   Tasks  │ │  │ │   Tasks  │ │               │    │
│  │  │ └──────────┘ │  │ └──────────┘ │               │    │
│  │  │              │  │              │               │    │
│  │  │ ┌──────────┐ │  │ ┌──────────┐ │               │    │
│  │  │ │    NAT   │ │  │ │    NAT   │ │               │    │
│  │  │ │  Gateway │ │  │ │  Gateway │ │               │    │
│  │  │ └──────────┘ │  │ └──────────┘ │               │    │
│  │  └──────────────┘  └──────────────┘               │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────┐  ┌──────────────┐                     │
│  │   CloudWatch    │  │  Auto Scaling│                     │
│  │     Logs        │  │    Groups    │                     │
│  └─────────────────┘  └──────────────┘                     │
└──────────────────────────────────────────────────────────────┘
```

## GCP Cloud Run Architecture (Fallback)

```
┌──────────────────────────────────────────────────────────┐
│                  Google Cloud Platform                   │
│                                                          │
│  ┌────────────────────────────────────────────────┐     │
│  │         Global Load Balancer                   │     │
│  │  ┌──────────────────────────────────────┐      │     │
│  │  │   Global External HTTP(S) LB         │      │     │
│  │  │   - Health Checks                    │      │     │
│  │  │   - URL Mapping                      │      │     │
│  │  └──────────────┬───────────────────────┘      │     │
│  └─────────────────┼────────────────────────────────┘     │
│                    │                                      │
│  ┌─────────────────▼────────────────────────────────┐     │
│  │         Backend Service                         │     │
│  │  ┌───────────────────────────────────────┐      │     │
│  │  │  Network Endpoint Group (NEG)         │      │     │
│  │  │  - Serverless NEG for Cloud Run       │      │     │
│  │  └───────────────────────────────────────┘      │     │
│  └──────────────────────────────────────────────────┘     │
│                                                          │
│  ┌──────────────────────────────────────────────────┐     │
│  │         Cloud Run Service                       │     │
│  │                                                  │     │
│  │  Instances: 1-10 (Auto-scaling)                 │     │
│  │  CPU: 2 vCPU per instance                       │     │
│  │  Memory: 2 GiB per instance                     │     │
│  │  Concurrency: 80 requests/instance              │     │
│  │                                                  │     │
│  │  Container: prebid-server:latest                │     │
│  │  Port: 8080                                     │     │
│  │  Health: /status endpoint                       │     │
│  └──────────────────────────────────────────────────┘     │
│                                                          │
│  ┌─────────────────┐  ┌──────────────┐                  │
│  │  Cloud Logging  │  │   Cloud      │                  │
│  │                 │  │  Monitoring  │                  │
│  └─────────────────┘  └──────────────┘                  │
└──────────────────────────────────────────────────────────┘
```

## Failover Strategy
